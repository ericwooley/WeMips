<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <title>The source code</title>
  <link href="../resources/prettify/prettify.css" type="text/css" rel="stylesheet" />
  <script type="text/javascript" src="../resources/prettify/prettify.js"></script>
  <style type="text/css">
    .highlight { display: block; background-color: #ddd; }
  </style>
  <script type="text/javascript">
    function highlight() {
      document.getElementById(location.hash.replace(/#/, "")).className = "highlight";
    }
  </script>
</head>
<body onload="prettyPrint(); highlight();">
  <pre class="prettyprint lang-js">$(document).ready(function(){

    // Code Mirror setup
    var me = mips_emulator({
        debug: true,
        onRegisterChange: function(reg_name, value){
            var reg = $(&quot;#&quot; + reg_name.replace(&#39;$&#39;, &#39;&#39;) + &quot; .reg_spacer&quot;);
            $(&quot;.last_reg_changed&quot;).removeClass(&#39;last_reg_changed&#39;);
            reg.html(value);
            reg.addClass(&#39;last_reg_changed&#39;);
            // change to correct tab
            var reg_letter = reg_name.replace(&#39;$&#39;, &#39;&#39;).replace(/\s/, &#39;&#39;).charAt(0);
            $(&#39;#registers a[href=&quot;#&#39;+reg_letter+&#39;-registers&quot;]&#39;).tab(&#39;show&#39;)
        },
        onFinish: function(){
            alert(&quot;Emulation complete, returning to line 1&quot;);
            me.setLine(1);
            set_highlights({line_ran: active_line, next_line: me.get_line_number()})
        },
        starting_code: $(&quot;#editor&quot;).val()
    });
    // The next time we go to step or run, we need to reset the code from the text editor.
    me.valid = false; 
    var editor = CodeMirror.fromTextArea(
        document.getElementById(&quot;editor&quot;),{
          lineNumbers: true,
          mode: &quot;text/css&quot;,
          matchBrackets: true,
      //viewportMargin: &#39;Infinity&#39;
    });
    editor.on(&#39;change&#39;, function(){
        me.valid = false;
    });

    // Mips emulator setup.
    $(&quot;.registers-container li&quot;).each(function(index){
        var reg = $(this);
        var reg_name = reg.attr(&#39;id&#39;);
        reg.html(
            &quot;&lt;b&gt;&quot;+reg_name +&quot;:&lt;/b&gt; &quot; 
            + &quot;&lt;span class=&#39;reg_spacer&#39; reg=&#39;&quot;+reg_name+&quot;&#39; id=&#39;&quot;+reg_name+&quot;-val&#39; contenteditable=&#39;true&#39;&gt;&quot;
            + me.getRegister(reg_name)
            + &quot;&lt;/span&gt;&quot;
        );
    });
    $(&#39;.reg_spacer&#39;).on(&#39;input&#39;, function(e){
        var new_val = $(e.target).html();
        var target =  $(e.target);
        var reg_name = target.attr(&quot;reg&quot;);
        if(new_val.search(/[\D\s]/) &gt;= 0){
            target.html(new_val.replace(/[\D\s]/g, &#39;&#39;));
            alert(&quot;You cannot enter in characters into registers&quot;);
        }
        if(new_val.length &gt; 11){
            target.html(new_val.substring(0, 11));
            alert(&quot;The 32 bit integers can only be 11 digits long.&quot;);
        }
        
        return true;
    });
    $(&#39;.reg_spacer&#39;).on(&#39;blur&#39;, function(e){
        var new_val = $(e.target).html();
        var target =  $(e.target);
        var reg_name = target.attr(&quot;reg&quot;);
        me.setRegister(reg_name, Number(new_val), false);
    });
    $(&#39;#code_loaders button&#39;).on(&#39;click&#39;, function(e){
        var target = $(e.target);
        var load_target = target.attr(&#39;load&#39;);
        var new_content = $(load_target).html();
        editor.setValue(new_content);
        me.valid = false;
    });
    // Step throught emulator function 
    $(&quot;#step&quot;).click(function(){
        // if this code is no longer valid, reanalyze.
        if(!me.valid){
            editor.save();
            me.setCode($(&quot;#editor&quot;).val());
            me.valid = true;
        }

        line_result = me.step();
        if(line_result){
           set_highlights(line_result);
        }
    });
    $(&quot;#go_to_line_button&quot;).on(&#39;click&#39;, function(){
        var new_line = $(&quot;#current_line_input&quot;).val();
        console.log(&quot;Setting new line: &quot;+ new_line);
        me.setLine(Number(new_line));
        console.log(&quot;next_line&quot;+ me.get_line_number());
        set_highlights({line_ran: null, next_line: me.get_line_number()})
        return false;
    });
    var active_line;
    var next_line;
    var active_marker
    var next_marker = editor.markText(
        {line: 0, ch: 0},
        {line: 1, ch: 0},
        {title: &quot;Next line to be run&quot;, className: &#39;next_line&#39;}
    );
    function set_highlights(lines){
        active_line = lines.line_ran;
        next_line = lines.next_line;
        console.log(&quot;Active line: &quot; + active_line);
        console.log(&quot;Next line: &quot; + next_line);
        $(&quot;#current_line_input&quot;).val(next_line);
        //$(&quot;.active_line&quot;).removeClass(&#39;active_line&#39;);
        //$(&quot;.next_line&quot;).removeClass(&#39;next_line&#39;);
        if(active_marker) active_marker.clear();
        active_marker = editor.markText(
            {line: active_line-1, ch: 0},
            {line: active_line, ch: 0},
            {title: &quot;last line ran&quot;, className: &#39;active_line&#39;}
        );
        if(next_marker) next_marker.clear();
        next_marker = editor.markText(
            {line: next_line-1, ch: 0},
            {line: next_line, ch: 0},
            {title: &quot;Next line to be run&quot;, className: &#39;next_line&#39;}
        );

    }
    // Run code non-stop function
    $(&quot;#run&quot;).click(function(){
        // if this code is no longer valid, reanalyze.
        if(!me.valid){
            editor.save();
            me.setCode($(&quot;#editor&quot;).val());
            me.valid = true;
        } 
      // TODO: hook this up to a mips engine
      alert(&quot;Run Fucntion here&quot;);
    });

});</pre>
</body>
</html>
